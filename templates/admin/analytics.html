{% extends "base.html" %}
{% block title %}数据分析{% endblock %}
{% block content %}
{% include "admin/nav.html" with context %}

<section class="panel">
  <div class="panel-header">
    <div>
      <p class="label subtle">可视化洞察</p>
      <h2>访问 & 爬虫分析</h2>
      <p class="muted">按天统计访问趋势，拆解爬虫来源、识别率与最近的 UA 详情。</p>
    </div>
    <div class="muted">近 45 天留存 · 识别模式实时更新</div>
  </div>
  <div class="summary-grid">
    <div class="stat-card">
      <p class="muted">总访问</p>
      <strong>{{ total_views }}</strong>
      <small>累计真实与爬虫访问总览</small>
    </div>
    <div class="stat-card">
      <p class="muted">最近 7 天</p>
      <strong>{{ last_7_views }}</strong>
      <small>便于对比短期波动</small>
    </div>
    <div class="stat-card">
      <p class="muted">昨日/今日</p>
      <strong>{{ last_day_views }}</strong>
      <small>按天聚合的最新访问量</small>
    </div>
    <div class="stat-card">
      <p class="muted">爬虫家族</p>
      <strong>{{ family_breakdown|length }}</strong>
      <small>已识别品牌占比</small>
    </div>
  </div>
</section>

<section class="grid two-up">
  <div class="panel">
    <div class="panel-header">
      <h3>访问趋势（按天）</h3>
      <p class="muted">近 45 天访问曲线，便于观察波峰波谷。</p>
    </div>
    {% set max_view = view_trend | max(attribute='views') if view_trend else 1 %}
    <div class="trend-list">
      {% for day in view_trend %}
        <div class="trend-row">
          <div class="trend-meta">
            <strong>{{ day.date }}</strong>
            <span class="muted small">{{ day.views }} 次</span>
          </div>
          <div class="bar">
            <span style="width: {{ (day.views / (max_view or 1) * 100) | round(2) }}%"></span>
          </div>
        </div>
      {% else %}
        <p class="muted">暂无访问记录，等待新的访问数据。</p>
      {% endfor %}
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <h3>爬虫识别率</h3>
      <p class="muted">按品牌聚合的抓取次数与识别占比。</p>
    </div>
    <div class="table small">
      <div class="row head"><span>品牌</span><span>占比</span><span>抓取次数</span></div>
      {% set max_hits = family_breakdown | max(attribute='hits') if family_breakdown else 1 %}
      {% for item in family_breakdown %}
        {% set percent = (item.hits / max_hits * 100) | round(1) %}
        <div class="row">
          <span>{{ item.family }}</span>
          <span>
            <div class="bar inline"><span style="width: {{ percent }}%"></span></div>
            <small class="muted">{{ percent }}%</small>
          </span>
          <span>{{ item.hits }}</span>
        </div>
      {% else %}
        <p class="muted">还没有爬虫抓取记录。</p>
      {% endfor %}
    </div>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <h3>按天拆解爬虫来源</h3>
    <p class="muted">汇总每天的抓取品牌，便于判断收录节奏。</p>
  </div>
  <div class="table small">
    <div class="row head"><span>日期</span><span>品牌详情</span><span>合计</span></div>
    {% for date, entries in bot_daily_by_date.items() %}
      {% set total = entries | sum(attribute='hits') %}
      <div class="row">
        <span>{{ date }}</span>
        <span>
          <div class="badges">
            {% for entry in entries %}
              <span>{{ entry.family }} · {{ entry.hits }}</span>
            {% endfor %}
          </div>
        </span>
        <span>{{ total }}</span>
      </div>
    {% else %}
      <p class="muted">暂无按天爬虫数据。</p>
    {% endfor %}
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <h3>最近 UA 记录</h3>
    <p class="muted">识别后的 UA 全量列表，方便继续补充模式。</p>
  </div>
  <div class="table small">
    <div class="row head"><span>品牌</span><span>UA</span><span>次数</span></div>
    {% for bot in bot_hits %}
      <div class="row">
        <span>{{ bot.family }}</span>
        <span class="muted small">{{ bot.ua }}</span>
        <span>{{ bot.hits }}</span>
      </div>
    {% else %}
      <p class="muted">暂无 UA 记录。</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
