{% extends "base.html" %}
{% block title %}后台概览{% endblock %}
{% block content %}
{% include "admin/nav.html" with context %}

<section class="panel">
  <div class="panel-header">
    <div>
      <p class="label subtle">运行状态</p>
      <h2>数据概览</h2>
      <p class="muted">速览当前内容量、访问热度及爬虫抓取情况。</p>
    </div>
    <div class="muted">线程：{{ settings.ai_thread_count or 8 }} · 字数：{{ settings.article_min_words or 800 }}-{{ settings.article_max_words or 1500 }}</div>
  </div>
  <div class="summary-grid">
    <div class="stat-card">
      <p class="muted">总页面</p>
      <strong>{{ pages|length }}</strong>
      <small>包含批量生成与单页编排</small>
    </div>
    <div class="stat-card">
      <p class="muted">累计访问</p>
      <strong>{{ stats_map.values()|sum }}</strong>
      <small>记录自带防丢失合并</small>
    </div>
    <div class="stat-card">
      <p class="muted">识别爬虫</p>
      <strong>{{ bot_hits|length }}</strong>
      <small>最近捕获的来源 UA</small>
    </div>
    <div class="stat-card">
      <p class="muted">AI 日志</p>
      <strong>{{ ai_logs|length }}</strong>
      <small>最近 50 条调用记录</small>
    </div>
  </div>
</section>

<section class="grid two-up">
  <div class="panel">
    <div class="panel-header">
      <h3>访问热度</h3>
      <p class="muted">基于访问统计的表现亮点。</p>
    </div>
    <ol class="compact">
      {% for item in top_performers %}
        <li><a href="/p/{{ item.slug }}" target="_blank">{{ item.title }}</a> · {{ item.views }} 次</li>
      {% else %}
        <li>等待新的访问数据。</li>
      {% endfor %}
    </ol>
  </div>
  <div class="panel">
    <div class="panel-header">
      <h3>爬虫来源</h3>
      <p class="muted">后台记录到的 UA、品牌与抓取次数。</p>
    </div>
    <div class="table small">
      <div class="row head"><span>来源</span><span>UA</span><span>次数</span></div>
      {% for bot in bot_hits %}
        <div class="row">
          <span>{{ bot.family }}</span>
          <span class="muted small">{{ bot.ua }}</span>
          <span>{{ bot.hits }}</span>
        </div>
      {% else %}
        <p class="muted">暂无爬虫访问记录。</p>
      {% endfor %}
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">
      <h3>域名表现</h3>
      <p class="muted">按泛域名拆分内容量与访问量，方便分发策略调整。</p>
    </div>
    <div class="table small">
      <div class="row head"><span>域名</span><span>更新时间</span><span>页面数 / 访问</span></div>
      {% for item in domain_stats %}
        <div class="row">
          <span>{{ item.host }}</span>
          <span class="muted small">{{ item.latest or '未生成' }}</span>
          <span>{{ item.count }} / {{ item.views }}</span>
        </div>
      {% else %}
        <p class="muted">暂无域名数据，等待首次访问或生成。</p>
      {% endfor %}
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">
      <h3>最近稿件</h3>
      <p class="muted">按更新时间排序，便于确认内容健康度。</p>
    </div>
    <ul class="list spaced">
      {% for page in recent_pages %}
        <li>
          <div>
            <strong><a href="/p/{{ page.slug }}" target="_blank">{{ page.title or page.topic or page.slug }}</a></strong>
            <div class="muted small">{{ page.updated_at or page.created_at or '未知' }} · 关键词：{{ page.keywords | join(' / ') }}</div>
          </div>
        </li>
      {% else %}
        <li class="muted">暂无内容更新。</li>
      {% endfor %}
    </ul>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h3>最近 AI 日志</h3>
      <p class="muted">用于排查 DeepSeek 生成问题。</p>
    </div>
    <a class="button ghost" href="/admin/content">前往生成</a>
  </div>
  <div class="log-window">
    {% for item in ai_logs|reverse %}
      <div class="log-entry {{ item.level }}">
        <strong>[{{ item.level|upper }}]</strong> {{ item.timestamp or '' }} · {{ item.message }}
        {% if item.meta %}<div class="muted small">{{ item.meta }}</div>{% endif %}
      </div>
    {% else %}
      <p class="muted">暂无调用记录。</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
